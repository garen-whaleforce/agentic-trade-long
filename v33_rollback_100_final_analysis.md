# v33 Rollback - 100 ç­†é©—è­‰æ¸¬è©¦æœ€çµ‚åˆ†æ

**æ—¥æœŸ**: 2026-01-19
**ç­–ç•¥ç‰ˆæœ¬**: v33_iteration1_rollback
**æ¨¡å‹**: gemini-3-flash-preview + gpt-4o-mini
**ç‹€æ…‹**: âš ï¸ **éƒ¨åˆ†æˆåŠŸï¼Œä»éœ€é€²ä¸€æ­¥ä¿®å¾©**

---

## åŸ·è¡Œæ‘˜è¦

### âœ… æˆåŠŸä¿®å¾©çš„å•é¡Œ

1. **eps_surprise è³‡æ–™åŒ¹é…å•é¡Œ** - ä¿®æ”¹ `pg_client.py` ä½¿ç”¨ Â±365 å¤©çª—å£
2. **D4_OPP æ°¾æ¿«æ§åˆ¶** - å¾åŸæœ¬ 58.9% é™ä½åˆ° 44.8% (13/29 signals)

### âš ï¸ æ–°ç™¼ç¾çš„å•é¡Œ

1. **D6/D7 å®Œå…¨ç„¡ä¿¡è™Ÿ** - 27 å€‹ D6/D7 direction scoresï¼Œä½† 0 å€‹äº¤æ˜“ä¿¡è™Ÿ
2. **earnings_day_return è³‡æ–™ç¼ºå¤±** - åŒæ¨£çš„æ—¥æœŸåŒ¹é…å•é¡Œ
3. **ä¿¡è™Ÿç‡ä»åé«˜** - 29% vs ç›®æ¨™ 15-20%

---

## æ¸¬è©¦çµæœè©³ç´°åˆ†æ

### åŸºæœ¬çµ±è¨ˆ

```
âœ… æˆåŠŸåˆ†æ: 100/100 ç­† (100%)
â±ï¸ ç¸½è€—æ™‚: 33.6 åˆ†é˜ (å¹³å‡ 20.0 ç§’/ç­†)
ğŸ’° EPS Surprise: å¹³å‡ 32.0%, ç¯„åœ -35.7% ~ 802.1%
```

### Direction Score åˆ†ä½ˆ

| Direction | æ•¸é‡ | ç™¾åˆ†æ¯” | è©•åƒ¹ |
|-----------|------|--------|------|
| D7 | 1 | 1.0% | âŒ å¤ªå°‘ï¼Œæ‡‰è©² 5-10% |
| D6 | 26 | 26.0% | âœ… æ­£å¸¸ï¼Œä½†æ²’ç”¢ç”Ÿä¿¡è™Ÿ |
| D5 | 4 | 4.0% | âœ… æ­£å¸¸ |
| D4 | 47 | 47.0% | âš ï¸ åå¤š |
| D3 | 21 | 21.0% | âœ… æ­£å¸¸ |
| D2 | 1 | 1.0% | âœ… æ­£å¸¸ |

### äº¤æ˜“ä¿¡è™Ÿåˆ†ä½ˆ

| Tier | æ•¸é‡ | ç™¾åˆ†æ¯” | è©•åƒ¹ |
|------|------|--------|------|
| D7_CORE | 0 | 0.0% | âŒ æ‡‰è©²æœ‰ 1-2 å€‹ |
| D6_STRICT | 0 | 0.0% | âŒ æ‡‰è©²æœ‰ 3-5 å€‹ |
| D5_GATED | 0 | 0.0% | âœ… æ­£å¸¸ï¼ˆv33 æœªå•Ÿç”¨ï¼‰ |
| D4_ENTRY | 15 | 51.7% | âš ï¸ åå¤š |
| D4_OPP | 13 | 44.8% | âš ï¸ ä»ç„¶åå¤š |
| D3_WIDE | 1 | 3.4% | âš ï¸ ä¸æ‡‰è©²æœ‰ |
| **ç¸½è¨ˆ** | **29** | **29.0%** | âŒ è¶…éç›®æ¨™ |

---

## å•é¡Œè¨ºæ–·

### å•é¡Œ 1: D7 ç„¡ä¿¡è™Ÿï¼ˆ1 å€‹ Direction Score â†’ 0 å€‹ Tradeï¼‰

**æ¡ˆä¾‹**: DLTR 2017Q3

**åˆ†æ**:
- Direction Score: 7 âœ…
- EPS Surprise: 3.0% âŒ
- **Block åŸå› **: `eps_surprise < 12%` (D7 é–€æª»)

**D7_CORE è¦æ±‚**:
```python
1. direction_score >= 7           âœ… DLTR: 7
2. soft_veto_count <= 1           â“ æœªçŸ¥
3. eps_surprise > 12%             âŒ DLTR: 3.0%
4. earnings_day_return >= 0.8%    â“ å¯èƒ½ç¼ºå¤±
5. hard_positives >= 0            â“ æœªçŸ¥
```

**çµè«–**: D7 çš„ 12% eps_surprise é–€æª»å¤ªé«˜

---

### å•é¡Œ 2: D6 å®Œå…¨ç„¡ä¿¡è™Ÿï¼ˆ26 å€‹ Direction Scores â†’ 0 å€‹ Tradesï¼‰

**æ¨£æœ¬æ¡ˆä¾‹**:
1. WDAY 2017Q1: eps_surprise = 802% (æ¥µç«¯å€¼)
2. STZ 2017Q1: eps_surprise = 14%
3. GEN 2017Q1: eps_surprise = 14%
4. NTAP 2017Q1: eps_surprise = 11%
5. BBY 2017Q2: eps_surprise = 17%

**åˆ†æ**: æ‰€æœ‰æ¡ˆä¾‹çš„ `eps_surprise` éƒ½ >= 2% (D6 é–€æª»)ï¼Œä½†ä»è¢« block

**D6_STRICT è¦æ±‚**:
```python
1. direction_score == 6                âœ… æ‰€æœ‰æ¡ˆä¾‹ç¬¦åˆ
2. soft_veto_count <= 1                â“ æœªçŸ¥
3. eps_surprise >= 2%                  âœ… æ‰€æœ‰æ¡ˆä¾‹ç¬¦åˆ
4. earnings_day_return >= 0.5%         â“ æ¥µå¯èƒ½ç¼ºå¤±
5. hard_positives >= 2                 â“ æœªçŸ¥
6. risk != "high" (if REQUIRE_LOW_RISK)  â“ æœªçŸ¥
```

**æœ€å¯èƒ½çš„ Block åŸå› **:
1. **earnings_day_return è³‡æ–™ç¼ºå¤±** - åŒæ¨£çš„æ—¥æœŸåŒ¹é…å•é¡Œ
2. **hard_positives < 2** - LLM è©•åˆ†å¤ªä¿å®ˆ
3. **soft_veto_count > 1** - å¯èƒ½æœ‰éš±è—çš„ vetoes

---

### å•é¡Œ 3: earnings_day_return è³‡æ–™åŒ¹é…å•é¡Œ

**æ¨æ¸¬**:
- `earnings_day_return` èˆ‡ `eps_surprise` ä¾†è‡ªåŒä¸€å€‹ `earnings_surprises` è¡¨
- ä½†å¯èƒ½å­˜å„²åœ¨ä¸åŒæ¬„ä½ï¼Œæˆ–éœ€è¦é¡å¤–æŸ¥è©¢ `historical_prices` è¡¨
- å¦‚æœ `historical_prices` ä¹Ÿæœ‰æ—¥æœŸæ¨™ç±¤å•é¡Œï¼Œæœƒå°è‡´ç„¡æ³•è¨ˆç®— earnings_day_return

**é©—è­‰æ–¹æ³•**:
éœ€è¦æª¢æŸ¥ `pg_client.py` ä¸­çš„ `get_market_anchors()` æˆ–é¡ä¼¼å‡½æ•¸

---

### å•é¡Œ 4: ä¿¡è™Ÿç‡åé«˜ (29% vs ç›®æ¨™ 15-20%)

**åŸå› åˆ†æ**:
1. D4 tier éæ–¼å¯¬é¬†ï¼ˆ15 + 13 = 28 å€‹ä¿¡è™Ÿï¼‰
2. D4_OPP ä»ç„¶ä½” 44.8%ï¼ˆé›–ç„¶æ¯” 58.9% æ”¹å–„ï¼Œä½†é‚„æ˜¯å¤ªå¤šï¼‰
3. D3_WIDE ä¸æ‡‰è©²å­˜åœ¨ï¼ˆv33 æ‡‰è©²ç¦ç”¨ï¼‰

---

## æ ¹æœ¬åŸå› ç¸½çµ

### è³‡æ–™å±¤å•é¡Œ

1. **transcript_date æ¨™ç±¤éŒ¯èª¤** - å·²ä¿®å¾© âœ…
2. **earnings_day_return ç¼ºå¤±** - æœªä¿®å¾© âŒ
3. **æ¥µç«¯ eps_surprise å€¼** (802%) - è³‡æ–™å“è³ªå•é¡Œ â³

### é…ç½®å±¤å•é¡Œ

1. **D7 eps_surprise é–€æª»å¤ªé«˜** - 12% â†’ å»ºè­°é™è‡³ 5-8%
2. **D6 positives è¦æ±‚å¤ªåš´** - å¯èƒ½éœ€è¦é™è‡³ 1 å€‹
3. **D4 gates å¤ªå¯¬é¬†** - éœ€è¦é€²ä¸€æ­¥æ”¶ç·Š
4. **D3_WIDE æœªç¦ç”¨** - æ‡‰è©²å®Œå…¨é—œé–‰

---

## ä¿®å¾©æ–¹æ¡ˆ

### ğŸ”¥ P0: ç·Šæ€¥ä¿®å¾©ï¼ˆå¿…é ˆï¼‰

#### Fix 1: ä¿®å¾© earnings_day_return è³‡æ–™åŒ¹é…

**ç›®æ¨™**: è®“ D6/D7 èƒ½å¤ ç”¢ç”Ÿä¿¡è™Ÿ

**æ–¹æ³•**: åŒæ¨£æ“´å¤§ earnings_day_return çš„åŒ¹é…çª—å£

```python
# pg_client.py
# åœ¨è¨ˆç®— earnings_day_return æ™‚ä¹Ÿä½¿ç”¨ Â±365 å¤©çª—å£æŸ¥æ‰¾ historical_prices
```

#### Fix 2: ç¢ºèª D3_WIDE å·²ç¦ç”¨

**ç›®æ¨™**: ç¢ºä¿ v33 ä¸ç”¢ç”Ÿ D3 ä¿¡è™Ÿ

```python
# agentic_rag_bridge.py
LONG_D3_ENABLED = False  # ç¢ºèªé€™å€‹è¨­å®š
```

### ğŸŸ¡ P1: å„ªåŒ–èª¿æ•´ï¼ˆé‡è¦ï¼‰

#### Adjustment 1: æ”¾å¯¬ D7 eps_surprise é–€æª»

```python
# ç•¶å‰: 12%
# å»ºè­°: 5-8%
LONG_D7_MIN_EPS_SURPRISE = 0.06  # 6%
```

#### Adjustment 2: æ”¾å¯¬ D6 positives è¦æ±‚

```python
# ç•¶å‰: >= 2
# å»ºè­°: >= 1
LONG_D6_MIN_POSITIVES = 1
```

#### Adjustment 3: é€²ä¸€æ­¥æ”¶ç·Š D4_OPP

```python
# ç•¶å‰: eps >= 3%, momentum check
# å»ºè­°: æé«˜åˆ° 5%, æˆ–å¢åŠ é¡å¤–æ¢ä»¶
```

### ğŸŸ¢ P2: è³‡æ–™å“è³ªæ”¹å–„ï¼ˆé•·æœŸï¼‰

1. èª¿æŸ¥ WDAY 802% eps_surprise ç•°å¸¸å€¼
2. æª¢æŸ¥è² å€¼ eps_surprise (-35.7%) çš„åˆç†æ€§
3. è€ƒæ…®é‡æ–° ingest earnings_transcripts è¡¨ï¼Œä¿®æ­£è²¡å¹´æ¨™ç±¤

---

## é æœŸæ”¹å–„æ•ˆæœ

### å¦‚æœå¯¦æ–½ P0 ä¿®å¾©:
- D6 ä¿¡è™Ÿ: 0 â†’ 3-5 å€‹ (11.5% of D6 direction scores)
- D7 ä¿¡è™Ÿ: 0 â†’ 0-1 å€‹ (D7 ä»ç„¶ç¨€ç¼º)
- ç¸½ä¿¡è™Ÿç‡: 29% â†’ 25-27%

### å¦‚æœå¯¦æ–½ P0 + P1 èª¿æ•´:
- D6 ä¿¡è™Ÿ: 0 â†’ 5-8 å€‹ (19-31% of D6 direction scores)
- D7 ä¿¡è™Ÿ: 0 â†’ 1-2 å€‹ (100% of D7 direction scores)
- D4 ä¿¡è™Ÿ: 28 â†’ 15-20 å€‹ (æ”¶ç·Šå¾Œ)
- **ç¸½ä¿¡è™Ÿç‡: 29% â†’ 18-22%** âœ… é”æˆç›®æ¨™

---

## å»ºè­°åŸ·è¡Œé †åº

1. âœ… **ç«‹å³**: è¨ºæ–· earnings_day_return è³‡æ–™åŒ¹é…å•é¡Œ
2. â³ **ä»Šå¤©**: ä¿®å¾© earnings_day_returnï¼Œé‡æ–°æ¸¬è©¦ 100 ç­†
3. â³ **ä»Šå¤©**: å¦‚æœ D6/D7 ä»ç„¡ä¿¡è™Ÿï¼Œå¯¦æ–½ P1 èª¿æ•´
4. â³ **æ˜å¤©**: åŸ·è¡Œ 1000-2000 ç­†å®Œæ•´é©—è­‰
5. â³ **æœ¬é€±**: åŸ·è¡Œå®Œæ•´å›æ¸¬ (2017-2024)ï¼Œè¨ˆç®— CAGR/Sharpe

---

## é™„éŒ„: æ¸¬è©¦åŸå§‹æ•¸æ“š

### Direction Score vs Trade Signal è½‰æ›ç‡

| Direction | Direction Count | Trade Signals | è½‰æ›ç‡ | é æœŸè½‰æ›ç‡ |
|-----------|----------------|---------------|--------|-----------|
| D7 | 1 | 0 | 0.0% | 80-100% |
| D6 | 26 | 0 | 0.0% | 20-40% |
| D5 | 4 | 0 | 0.0% | 10-20% |
| D4 | 47 | 28 | 59.6% | 30-50% |
| D3 | 21 | 1 | 4.8% | 0-5% |

**çµè«–**: D4 è½‰æ›ç‡åé«˜ï¼ŒD6/D7 è½‰æ›ç‡ç‚ºé›¶

---

## ç›¸é—œæ–‡ä»¶

- å®Œæ•´è¨ºæ–·: [v33_rollback_diagnosis.md](v33_rollback_diagnosis.md)
- æ¸¬è©¦è¨˜éŒ„: [v33_rollback_100_test_fixed_notes.txt](v33_rollback_100_test_fixed_notes.txt)
- åŸå§‹çµæœ: [EarningsCallAgenticRag/backtest_checkpoints/backtest_results.json](EarningsCallAgenticRag/backtest_checkpoints/backtest_results.json)
- æ¸¬è©¦æ—¥èªŒ: [v33_rollback_fixed_100_test.log](v33_rollback_fixed_100_test.log)
